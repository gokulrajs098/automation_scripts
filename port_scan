#!/bin/bash

# Usage check
if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <ip_port_file>"
  echo "Example: $0 targets.txt"
  exit 1
fi

TARGET_FILE="$1"
OUTPUT_FILE="nmap_scan_$(date +%Y%m%d_%H%M%S).txt"

# Check if file exists
if [ ! -f "$TARGET_FILE" ]; then
  echo "Target file not found: $TARGET_FILE"
  exit 1
fi

echo "[*] Starting Nmap scan"
echo "[*] Target file: $TARGET_FILE"
echo "[*] Output file: $OUTPUT_FILE"
echo "------------------------------------"

while read -r line; do
  [[ -z "$line" ]] && continue   # skip empty lines

  IP=$(echo "$line" | cut -d':' -f1)
  PORT=$(echo "$line" | cut -d':' -f2)

  if [[ -z "$IP" || -z "$PORT" ]]; then
    echo "[!] Invalid entry: $line"
    continue
  fi

  echo "[*] Scanning $IP on port $PORT"
  echo "===== $IP:$PORT =====" >> "$OUTPUT_FILE"

  NMAP_OUTPUT=$(nmap -p "$PORT" "$IP" -Pn)

  # Save full output
  echo "$NMAP_OUTPUT" >> "$OUTPUT_FILE"
  echo >> "$OUTPUT_FILE"

  # Extract and print port state
  PORT_LINE=$(echo "$NMAP_OUTPUT" | grep -E "^$PORT/tcp")

  if echo "$PORT_LINE" | grep -q "open"; then
    echo "  [+] $IP:$PORT is OPEN"
  else
    echo "  [-] $IP:$PORT is CLOSED/FILTERED"
  fi

  echo "------------------------------------"

done < "$TARGET_FILE"

echo "[âœ”] Scan completed. Results saved in $OUTPUT_FILE"
